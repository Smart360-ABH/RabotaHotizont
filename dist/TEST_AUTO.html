<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Ç–µ—Å—Ç: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –°–µ—Å—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
            display: flex;
            gap: 30px;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .right-panel {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #e8eaf6;
            border-left-color: #764ba2;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.15);
        }
        
        .step.completed {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .step.failed {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .step h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
        
        .step.completed .step-number {
            background: #4caf50;
        }
        
        .step.failed .step-number {
            background: #f44336;
        }
        
        .step.active .step-number {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }
        
        .step p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .step-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .log-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        
        .log-item.success {
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .log-item.error {
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .log-item.warning {
            border-left-color: #ff9800;
            color: #e65100;
        }
        
        .log-item.info {
            border-left-color: #2196f3;
            color: #1565c0;
        }
        
        .summary {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .summary.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary h3 {
            color: #2e7d32;
            margin-bottom: 12px;
        }
        
        .summary-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .summary-item.pass::before {
            content: "‚úÖ";
        }
        
        .summary-item.fail::before {
            content: "‚ùå";
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #999;
            margin-left: 8px;
        }
        
        .status-indicator.online {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }
        
        .status-indicator.offline {
            background: #f44336;
        }
        
        .iframe-embed {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 12px;
            display: none;
        }
        
        .iframe-embed.show {
            display: block;
        }
        
        @media (max-width: 1024px) {
            .content {
                flex-direction: column;
            }
            
            .right-panel {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ –ê–≤—Ç–æ—Ç–µ—Å—Ç: –°–µ—Å—Å–∏—è –∏ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ—Å–ª–µ F5 (Refresh)</p>
        </div>
        
        <div class="content">
            <div class="left-panel">
                <!-- –®–∞–≥ 1 -->
                <div class="step" id="step1">
                    <h3>
                        <span class="step-number" id="step1-num">1</span>
                        <span>–ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
                        <span class="status-indicator" id="step1-status"></span>
                    </h3>
                    <p>–û—Ç–∫—Ä–æ–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Parse.</p>
                    <div class="step-actions">
                        <button class="btn-primary" onclick="goToStep1()">üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
                        <button class="btn-secondary" onclick="checkStep1Status()">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 2 -->
                <div class="step" id="step2">
                    <h3>
                        <span class="step-number" id="step2-num">2</span>
                        <span>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</span>
                        <span class="status-indicator" id="step2-status"></span>
                    </h3>
                    <p>
                        <strong>–õ–æ–≥–∏–Ω:</strong> Vladikabh23<br>
                        <strong>–ü–∞—Ä–æ–ª—å:</strong> 111111
                    </p>
                    <p style="color: #f44336; font-size: 13px;">
                        ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (–Ω–µ–ª—å–∑—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏). –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å".
                    </p>
                    <div class="step-actions">
                        <button class="btn-primary" onclick="checkStep2Status()">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ö–æ–¥</button>
                        <button class="btn-secondary" onclick="manualLoginCheck()">üë§ –Ø –≤–æ—à—ë–ª</button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 3 -->
                <div class="step" id="step3">
                    <h3>
                        <span class="step-number" id="step3-num">3</span>
                        <span>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
                        <span class="status-indicator" id="step3-status"></span>
                    </h3>
                    <p>
                        1. –ù–∞–π–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–æ–≤–∞—Ä<br>
                        2. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ—Ç–∞–ª–µ–π<br>
                        3. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–æ—Ç–∑—ã–≤ (—Ä–µ–π—Ç–∏–Ω–≥ 5 –∑–≤—ë–∑–¥)<br>
                        4. –ù–∞–∂–º–∏—Ç–µ —ç—Ç—É –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    </p>
                    <div class="step-actions">
                        <button class="btn-primary" onclick="checkStep3Status()">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                        <button class="btn-secondary" onclick="addTestReviewManually()">üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π</button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 4 -->
                <div class="step" id="step4">
                    <h3>
                        <span class="step-number" id="step4-num">4</span>
                        <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ (F5)</span>
                        <span class="status-indicator" id="step4-status"></span>
                    </h3>
                    <p>
                        –ù–∞–∂–º–∏—Ç–µ <strong>F5</strong> –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –∑–¥–µ—Å—å).
                    </p>
                    <div class="step-actions">
                        <button class="btn-primary" onclick="checkStep4Status()">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ F5</button>
                    </div>
                </div>
                
                <!-- –®–∞–≥ 5 -->
                <div class="step" id="step5">
                    <h3>
                        <span class="step-number" id="step5-num">5</span>
                        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
                        <span class="status-indicator" id="step5-status"></span>
                    </h3>
                    <p>
                        ‚úÖ <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Å—Ç–∞–ª—Å—è?</strong><br>
                        ‚úÖ <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω?</strong> (–∏–ª–∏ 403 ‚Äî —ç—Ç–æ –û–ö)<br>
                        ‚úÖ <strong>localStorage —Å–æ—Ö—Ä–∞–Ω—ë–Ω?</strong>
                    </p>
                    <div class="step-actions">
                        <button class="btn-primary" onclick="checkStep5Status()">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                        <button class="btn-secondary" onclick="showDetailedReport()">üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç</button>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-success" onclick="runFullTest()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ç–µ—Å—Ç</button>
                    <button class="btn-danger" onclick="resetTest()">üîÑ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                </div>
            </div>
            
            <div class="right-panel">
                <div style="margin-bottom: 12px; font-weight: bold; color: #333;">
                    üìã –õ–æ–≥–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                </div>
                <div id="logs"></div>
            </div>
        </div>
        
        <div class="summary" id="summary">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h3>
            <div id="summary-content"></div>
        </div>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let testState = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false,
            appWindow: null,
            checkpoints: {}
        };
        
        const credentials = {
            username: 'Vladikabh23',
            password: '111111'
        };
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            
            const icon = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';
            
            logItem.textContent = `[${timestamp}] ${icon} ${message}`;
            logs.appendChild(logItem);
            logs.scrollTop = logs.scrollHeight;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —à–∞–≥–∞
        function updateStepStatus(stepNum, status) {
            const element = document.getElementById(`step${stepNum}`);
            const statusIndicator = document.getElementById(`step${stepNum}-status`);
            
            element.classList.remove('active', 'completed', 'failed');
            statusIndicator.classList.remove('online', 'offline');
            
            if (status === 'active') {
                element.classList.add('active');
            } else if (status === 'completed') {
                element.classList.add('completed');
                statusIndicator.classList.add('online');
                testState[`step${stepNum}`] = true;
            } else if (status === 'failed') {
                element.classList.add('failed');
                statusIndicator.classList.add('offline');
            }
        }
        
        // –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function goToStep1() {
            log('–û—Ç–∫—Ä—ã–≤–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ...', 'info');
            testState.appWindow = window.open('http://localhost:3000', 'app_window', 'width=1200,height=800');
            
            if (testState.appWindow) {
                log('‚úÖ –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∞', 'success');
                setTimeout(() => checkStep1Status(), 2000);
            } else {
                log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É (–≤–æ–∑–º–æ–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ popup)', 'error');
            }
        }
        
        function checkStep1Status() {
            if (!testState.appWindow || testState.appWindow.closed) {
                log('‚ö†Ô∏è –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –∏–ª–∏ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–∞', 'warning');
                testState.appWindow = window.open('http://localhost:3000', 'app_window', 'width=1200,height=800');
            } else {
                log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ', 'success');
                updateStepStatus(1, 'completed');
                log('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –®–∞–≥—É 2: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', 'info');
            }
        }
        
        // –®–∞–≥ 2: –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        function checkStep2Status() {
            if (!testState.appWindow || testState.appWindow.closed) {
                log('‚ùå –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞', 'error');
                return;
            }
            
            try {
                const localStorage = testState.appWindow.localStorage;
                const market_user = localStorage.getItem('market_user');
                
                if (market_user) {
                    const user = JSON.parse(market_user);
                    if (user.sessionToken) {
                        log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω: ${user.username}`, 'success');
                        log(`   objectId: ${user.objectId}`, 'info');
                        log(`   sessionToken: ${user.sessionToken.substring(0, 20)}...`, 'info');
                        updateStepStatus(2, 'completed');
                        testState.checkpoints.login = { user, timestamp: new Date().toISOString() };
                        return;
                    }
                }
                
                log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.', 'warning');
            } catch (e) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${e.message}`, 'warning');
            }
        }
        
        function manualLoginCheck() {
            log('üë§ –í—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –≤—Ö–æ–¥. –ü—Ä–æ–≤–µ—Ä—è—é...', 'info');
            setTimeout(() => {
                checkStep2Status();
            }, 1000);
        }
        
        // –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        function checkStep3Status() {
            if (!testState.appWindow || testState.appWindow.closed) {
                log('‚ùå –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞', 'error');
                return;
            }
            
            try {
                const localStorage = testState.appWindow.localStorage;
                const market_reviews = localStorage.getItem('market_reviews');
                
                if (market_reviews) {
                    const reviews = JSON.parse(market_reviews);
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${reviews.length} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤`, 'success');
                    reviews.forEach((r, i) => {
                        log(`   [${i+1}] "${r.comment.substring(0, 40)}..." (rating: ${r.rating})`, 'info');
                    });
                    updateStepStatus(3, 'completed');
                    testState.checkpoints.beforeRefresh = { reviews, timestamp: new Date().toISOString() };
                    return;
                }
                
                log('‚ö†Ô∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–æ–≤–∞—Ä—É.', 'warning');
            } catch (e) {
                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${e.message}`, 'warning');
            }
        }
        
        function addTestReviewManually() {
            if (!testState.appWindow || testState.appWindow.closed) {
                log('‚ùå –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞', 'error');
                return;
            }
            
            try {
                const localStorage = testState.appWindow.localStorage;
                let reviews = [];
                
                try {
                    const existing = localStorage.getItem('market_reviews');
                    if (existing) reviews = JSON.parse(existing);
                } catch {}
                
                const testReview = {
                    id: Date.now().toString(),
                    productId: 'test-' + Date.now(),
                    userId: 'test-user',
                    userName: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    rating: 5,
                    comment: `–¢–ï–°–¢ –ê–í–¢–û–ú–ê–¢–ê: ${new Date().toLocaleString('ru-RU')}`,
                    date: new Date().toLocaleDateString('ru-RU')
                };
                
                reviews.push(testReview);
                localStorage.setItem('market_reviews', JSON.stringify(reviews));
                
                log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ localStorage', 'success');
                log(`   –í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${reviews.length}`, 'info');
                updateStepStatus(3, 'completed');
                testState.checkpoints.beforeRefresh = { reviews, timestamp: new Date().toISOString() };
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${e.message}`, 'error');
            }
        }
        
        // –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
        function checkStep4Status() {
            log('üìç –ù–∞–∂–º–∏—Ç–µ F5 –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (–≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ) –∏ –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ —ç—Ç—É –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞', 'warning');
            setTimeout(() => {
                checkAfterRefresh();
            }, 500);
        }
        
        function checkAfterRefresh() {
            if (!testState.appWindow || testState.appWindow.closed) {
                log('‚ùå –í–∫–ª–∞–¥–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∞', 'error');
                return;
            }
            
            try {
                const localStorage = testState.appWindow.localStorage;
                const market_reviews = localStorage.getItem('market_reviews');
                const market_user = localStorage.getItem('market_user');
                
                log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ F5:', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                if (market_reviews) {
                    const reviews = JSON.parse(market_reviews);
                    const beforeCount = testState.checkpoints.beforeRefresh?.reviews?.length || 0;
                    const afterCount = reviews.length;
                    
                    if (afterCount >= beforeCount) {
                        log(`   ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${afterCount} (–±—ã–ª–æ ${beforeCount})`, 'success');
                        testState.checkpoints.afterRefresh = { reviews, timestamp: new Date().toISOString() };
                    } else {
                        log(`   ‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã: ${afterCount} (–±—ã–ª–æ ${beforeCount})`, 'error');
                    }
                } else {
                    log('   ‚ùå localStorage market_reviews –ø—É—Å—Ç!', 'error');
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
                if (market_user) {
                    const user = JSON.parse(market_user);
                    if (user.sessionToken) {
                        log(`   ‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (sessionToken –µ—Å—Ç—å)`, 'success');
                    } else {
                        log(`   ‚ö†Ô∏è –°–µ—Å—Å–∏—è –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (sessionToken —É–¥–∞–ª—ë–Ω, –≤–æ–∑–º–æ–∂–Ω–æ 403 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)`, 'warning');
                    }
                } else {
                    log('   ‚ö†Ô∏è market_user —É–¥–∞–ª—ë–Ω –∏–∑ localStorage (–æ–∂–∏–¥–∞–µ–º–æ –ø—Ä–∏ 403)', 'warning');
                }
                
                updateStepStatus(4, 'completed');
                updateStepStatus(5, 'completed');
                showDetailedReport();
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${e.message}`, 'error');
            }
        }
        
        // –®–∞–≥ 5: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function checkStep5Status() {
            checkAfterRefresh();
        }
        
        function showDetailedReport() {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            const before = testState.checkpoints.beforeRefresh?.reviews || [];
            const after = testState.checkpoints.afterRefresh?.reviews || [];
            
            const testsResults = {
                '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ': testState.step1,
                '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω': testState.step2,
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã': before.length > 0,
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–æ—Å–ª–µ F5': after.length >= before.length,
                'localStorage.market_reviews –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω': after.length > 0
            };
            
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            for (const [test, result] of Object.entries(testsResults)) {
                html += `
                    <div class="summary-item ${result ? 'pass' : 'fail'}">
                        <span>${test}</span>
                    </div>
                `;
            }
            html += '</div>';
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            html += `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #ccc;">
                <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></p>
                <p>‚Ä¢ –î–æ F5: ${before.length} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                <p>‚Ä¢ –ü–æ—Å–ª–µ F5: ${after.length} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                <p>‚Ä¢ –ü–æ—Ç–µ—Ä—è–Ω–æ: ${Math.max(0, before.length - after.length)}</p>
            </div>`;
            
            summaryContent.innerHTML = html;
            summary.classList.add('show');
            
            log('üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –≥–æ—Ç–æ–≤', 'info');
        }
        
        // –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
        function runFullTest() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞...', 'info');
            goToStep1();
        }
        
        // –°–±—Ä–æ—Å —Ç–µ—Å—Ç–∞
        function resetTest() {
            testState = {
                step1: false,
                step2: false,
                step3: false,
                step4: false,
                step5: false,
                appWindow: null,
                checkpoints: {}
            };
            
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed', 'failed');
                step.querySelector('.status-indicator').classList.remove('online', 'offline');
            });
            
            document.getElementById('logs').innerHTML = '';
            document.getElementById('summary').classList.remove('show');
            
            log('üîÑ –¢–µ—Å—Ç —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            log('üéâ –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Ç–æ–≤', 'success');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" –¥–ª—è –Ω–∞—á–∞–ª–∞', 'info');
            log(`üìù –£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${credentials.username} / ${credentials.password}`, 'info');
        });
    </script>
</body>
</html>
