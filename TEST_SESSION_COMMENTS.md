# Тест: Восстановление комментариев после F5

## Цель
Убедиться что комментарии не исчезают после перезагрузки страницы (F5), и что сессия восстанавливается корректно.

## Ваши учётные данные для теста
- **Логин**: Vladikabh23
- **Пароль**: 111111

## Шаги теста

### Шаг 1: Вход в систему
1. Откройте консоль DevTools (F12)
2. Перейдите на http://localhost:3000/login
3. Введите логин: `Vladikabh23` и пароль: `111111`
4. Нажмите "Войти"
5. **Ожидаемо**: Вы должны увидеть "Вход успешен!" и перенаправиться на главную
6. **В консоли смотрите**: Логи Parse инициализации и `✅ Parse session restored` (если токен сохранён)

### Шаг 2: Проверка localStorage
1. Откройте DevTools → Application → Local Storage → http://localhost:3000
2. Найдите ключ `market_user` 
3. **Ожидаемо**: Должен содержать `sessionToken`, `objectId`, `username: "Vladikabh23"` и т.д.
4. Сохраните скриншот (для сравнения после F5)

### Шаг 3: Найти товар и добавить комментарий
1. Перейдите на http://localhost:3000/catalog или нажмите на какой-нибудь товар
2. Откройте страницу деталей товара (ProductDetails)
3. Прокрутите вниз до раздела "Отзывы"
4. В поле "Ваш отзыв" напишите тестовый комментарий, например: `Тест комментария - ${new Date().toISOString()}`
5. Оставьте рейтинг 5 звёзд
6. Нажмите кнопку отправить ("Отправить отзыв" или "Send")
7. **Ожидаемо**: Комментарий появится выше в списке отзывов

### Шаг 4: Проверка localStorage перед F5
1. Откройте DevTools → Application → Local Storage
2. Найдите ключ `market_reviews`
3. **Ожидаемо**: Должен содержать массив отзывов, включая ваш новый комментарий
4. Поиск вашего текста в значении (Ctrl+F в DevTools) — должен найтись

### Шаг 5: Перезагрузка (F5)
1. Нажмите F5 (Refresh) в браузере
2. **Внимание на консоль**: Должны появиться логи инициализации Parse
3. Ожидайте загрузки страницы

### Шаг 6: Проверка после F5
1. **Консоль**: Проверьте наличие:
   - `✅ Parse инициализирован успешно`
   - `✅ Parse session restored` ИЛИ `Failed to restore Parse session` (403)
2. **Логин**: 
   - Если сессия восстановлена → вы должны оставаться залогинены
   - Если 403 → может быть разлогинены (но это ОК — серверная ошибка)
3. **localStorage `market_user`**: 
   - Если залогинены → должен содержать sessionToken
   - Если разлогинены → должен быть удалён или не содержать sessionToken
4. **Комментарий**: 
   - Откройте ту же страницу товара
   - **КЛЮЧЕВОЙ ТЕСТ**: Ваш комментарий должен остаться! (он в localStorage `market_reviews`)
5. **localStorage `market_reviews`**: Должен всё ещё содержать ваш комментарий

### Шаг 7: Второй F5 (опционально)
Повторите Шаг 5-6 ещё раз:
- Нажмите F5 снова
- Проверьте что комментарий ещё остался
- Убедитесь что статус сессии стабилен

## Ожидаемые результаты

✅ **УСПЕХ:**
- Комментарий видна после F5 ✓
- `market_reviews` в localStorage сохранён ✓
- Если sessionToken валиден → пользователь остаётся залогинен ✓
- Консоль без критических ошибок (403 — это ОК, это серверная ошибка) ✓

❌ **ПРОБЛЕМЫ (требуют исправления):**
- Комментарий исчезла после F5 ✗
- localStorage `market_reviews` пуст после загрузки ✗
- Критическая ошибка в консоли (не Parse.User) ✗

## Логирование для диагностики

Если возникают проблемы, обратите внимание на:

1. **Консоль браузера (F12 → Console)**:
   ```
   // Хорошее состояние:
   ✅ Parse инициализирован успешно
   ✅ Parse session restored from sessionToken
   
   // Серверная ошибка сессии (ОК):
   Failed to restore Parse session: ParseError: unauthorized
   Cleared session from localStorage and notified UI
   ```

2. **Application → Local Storage**:
   - `market_user` — статус сессии
   - `market_reviews` — ваши комментарии (ГЛАВНОЕ)
   - `cart` — корзина
   - `theme` — тема

3. **Network (F12 → Network)**:
   - Поиск запросов к `parseapi.back4app.com/users/me` — статус (200, 401, 403)
   - Статус должен быть 200 если сессия валидна, 401/403 если истекла

## Заметки

- Parse session может быть невалидна на сервере (403 unauthorized) — это нормально для теста, главное что комментарии сохранены локально
- После F5 пользователь может быть разлогинен если токен истёк на сервере, но комментарии остаются (локальное хранилище)
- Если хотите проверить полный цикл логин + добавление комментариев, можно повторить Шаги 1-6 несколько раз
