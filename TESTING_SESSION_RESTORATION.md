# Инструкция по тестированию восстановления сессии

## Быстрый старт

### 1. Убедиться что окружение правильно настроено

```bash
# Проверить наличие .env.local с нужными переменными:
cat .env.local
```

Должны быть установлены:
```
VITE_PARSE_APP_ID=XLiNP1...
VITE_PARSE_JS_KEY=...
```

### 2. Запустить приложение

```bash
npm run dev
```

### 3. Открыть DevTools (F12)

Перейти на вкладку **Console** для просмотра логов.

---

## Тестовые сценарии

### Тест 1️⃣: Первоначальная авторизация

**Шаги:**
1. Откройте приложение на `http://localhost:5173`
2. Зайдите в Login страницу
3. Введите учетные данные
4. Нажмите Login

**Ожидаемый результат:**
- ✅ Успешная авторизация
- ✅ В консоли должны быть логи:
  ```
  Parse инициализирован
  ✅ Parse session restored from sessionToken
  ✅ User session restored successfully
  ```
- ✅ Пользователь виден в профиле
- ✅ В localStorage есть `market_user` с sessionToken

**Проверка в консоли:**
```javascript
// Откройте Console в DevTools и выполните:
localStorage.getItem('market_user') // Должно содержать sessionToken
Parse.User.current() // Должен вернуть текущего пользователя
```

---

### Тест 2️⃣: Восстановление сессии после перезагрузки

**Шаги:**
1. После успешной авторизации (Тест 1)
2. Нажмите F5 или выполните Ctrl+R для перезагрузки страницы
3. Понаблюдайте консоль

**Ожидаемый результат:**
- ✅ Страница загружается
- ✅ В консоли видны логи инициализации Parse:
  ```
  Parse инициализирован
  ✅ Parse session restored from sessionToken
  ✅ User session restored successfully
  ```
- ✅ Пользователь остается залогинен (видно в заголовке/меню)
- ✅ Не требуется повторная авторизация
- ✅ URL не изменяется на `/login`

**Проверка:**
```javascript
// Выполните в консоли:
Parse.User.current().get('username') // Должен вернуть username авторизованного пользователя
```

---

### Тест 3️⃣: Действия требующие аутентификации после перезагрузки

**Предварительно:**
- Пройти Тест 1 (авторизация)
- Пройти Тест 2 (перезагрузка)

**Шаги:**
1. Перейти на страницу продукта (Catalog → выбрать продукт)
2. Найти форму для комментария или другого действия требующего auth
3. Попытаться добавить комментарий ИЛИ добавить в избранное

**Ожидаемый результат:**
- ✅ Действие выполняется БЕЗ запроса на повторную авторизацию
- ✅ Комментарий/данные сохраняются
- ✅ В консоли нет ошибок аутентификации

---

### Тест 4️⃣: Истекший или невалидный sessionToken

**Шаги:**
1. После авторизации (Тест 1), откройте DevTools
2. В Console выполните:
   ```javascript
   // Удалите sessionToken
   const user = JSON.parse(localStorage.getItem('market_user'));
   user.sessionToken = 'invalid-token-12345';
   localStorage.setItem('market_user', JSON.stringify(user));
   ```
3. Перезагрузите страницу F5
4. Понаблюдайте консоль

**Ожидаемый результат:**
- ⚠️ В консоли ошибка при попытке восстановления сессии
- ✅ localStorage.market_user должен быть **удален** (очищен)
- ✅ Пользователь разлогинен
- ✅ Будет предложено авторизоваться заново

---

### Тест 5️⃣: Несколько перезагрузок подряд

**Шаги:**
1. Авторизуйтесь (Тест 1)
2. Перезагрузитесь F5 (5 раз)
3. Понаблюдайте поведение

**Ожидаемый результат:**
- ✅ Все перезагрузки выполняются успешно
- ✅ Сессия сохраняется всегда
- ✅ Логи инициализации видны при каждой перезагрузке
- ✅ Нет degradation производительности

---

## Отладка проблем

### Проблема: После перезагрузки пользователь разлогинен

**Что проверить:**

1. **Экспортированы ли переменные окружения?**
   ```bash
   # В терминале при запуске dev сервера должны быть логи:
   # ✓ VITE_PARSE_APP_ID loaded
   # ✓ VITE_PARSE_JS_KEY loaded
   ```

2. **В консоли браузера видна ошибка при восстановлении?**
   ```javascript
   // Проверьте что возвращает:
   Parse.User.current() // Должен вернуть объект пользователя, а не null
   ```

3. **SessionToken в localStorage?**
   ```javascript
   const user = JSON.parse(localStorage.getItem('market_user'));
   console.log(user.sessionToken); // Должна быть строка, не undefined
   ```

### Проблема: "Parse не инициализирован" в консоли

**Решение:**

1. Убедитесь что `.env.local` содержит VITE_PARSE_APP_ID и VITE_PARSE_JS_KEY
2. Перезапустите dev сервер: Ctrl+C, затем `npm run dev`
3. Очистите браузерный кеш: DevTools → Ctrl+Shift+Delete

### Проблема: Ошибка при попытке загрузить файл

**Шаги отладки:**

1. Проверьте консоль браузера на ошибки
2. Убедитесь что пользователь залогинен:
   ```javascript
   Parse.User.current() !== null // Должно быть true
   ```
3. Если ошибка "Session token invalid":
   - Parse sessionToken может быть истек (на Back4App)
   - Попробуйте заново авторизоваться

---

## Мониторинг через консоль

**Полезные команды для отладки:**

```javascript
// 1. Текущий пользователь
Parse.User.current()

// 2. SessionToken текущего пользователя
Parse.User.current()?.getSessionToken()

// 3. Сохраненный пользователь
JSON.parse(localStorage.getItem('market_user'))

// 4. Инициализирован ли Parse
typeof Parse !== 'undefined' && Parse.serverURL !== undefined

// 5. Проверить статус инициализации Back4App
// (откройте в консоли файл App.tsx логи)
```

---

## Критерии успеха

✅ **Все тесты пройдены, если:**

1. Пользователь авторизуется один раз и остается залогинен после F5
2. Все действия требующие auth работают без повторного логина
3. Невалидный sessionToken правильно обрабатывается (пользователь разлогинен)
4. Консоль не содержит критических ошибок

✅ **В продакшене это означает:**

- Нет постоянных запросов на авторизацию
- Пользователь может спокойно обновлять страницу
- Комментарии, заказы и другие операции работают после перезагрузки
- Лучший UX для пользователей приложения

---

## Дополнительные ссылки

- `SESSION_RESTORATION_FIX.md` - Полная документация изменений
- `services/back4app.ts` - Функции инициализации Parse
- `App.tsx` - Главный компонент с инициализацией
- `services/back4appRest.ts` - Функции для работы с Back4App
