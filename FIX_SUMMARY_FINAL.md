# üéâ –ò–¢–û–ì–û–í–û–ï –†–ï–ó–Æ–ú–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

## üìã –ü—Ä–æ–±–ª–µ–º–∞
**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏—Å—á–µ–∑–∞–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (F5)**

- ‚ùå –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –Ω–∞–∂–∞—Ç–∏—è F5 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–µ—Ä—è–ª–∏—Å—å
- ‚ùå localStorage `market_reviews` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏
- ‚ùå –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –º–æ–≥–ª–∞ –±—ã—Ç—å –ø—É—Ç–∞–Ω–∏—Ü–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (4 –∫–ª—é—á–µ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è)

### 1. **services/back4app.ts** - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ 403
```typescript
// –î–û: –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞–ª–æ—Å—å
// –ü–û–°–õ–ï:
export async function restoreSession(): Promise<boolean> {
  try {
    if (!Parse.applicationId) return false;
    const saved = localStorage.getItem('market_user');
    if (saved) {
      const user = JSON.parse(saved);
      if (user.sessionToken && user.objectId) {
        await Parse.User.become(user.sessionToken);
        console.info('‚úÖ Parse session restored from sessionToken');
        return true;
      }
    }
  } catch (e: any) {
    // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–∏ 403 —É–¥–∞–ª—è–µ–º localStorage –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
    if (e?.message?.includes('unauthorized') || e?.code === 101 || e?.status === 403) {
      console.warn('[RestoreSession] Token is invalid (401/403), clearing localStorage');
      localStorage.removeItem('market_user');
      notifySessionExpired(); // ‚Üê –û–ø–æ–≤–µ—â–∞–µ–º UI
    }
  }
  return false;
}

export function notifySessionExpired() {
  if (typeof window !== 'undefined') {
    // –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º localStorage
    localStorage.removeItem('market_user');
    const event = new CustomEvent('sessionExpired', {
      detail: { message: '–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' }
    });
    window.dispatchEvent(event);
    console.warn('[SessionExpired] Cleared session from localStorage and notified UI');
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403, –º—ã —è–≤–Ω–æ —É–¥–∞–ª—è–µ–º –º—ë—Ä—Ç–≤—ã–π —Ç–æ–∫–µ–Ω –∏ –æ–ø–æ–≤–µ—â–∞–µ–º UI.

---

### 2. **context/UserContext.tsx** - –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏
```typescript
// –î–û: –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
// –ü–û–°–õ–ï:
useEffect(() => {
  const handleSessionExpired = () => {
    console.info('[UserContext] Session expired, clearing user state');
    setUser(null); // ‚Üê –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ UI
    localStorage.removeItem('market_user'); // ‚Üê –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  };

  if (typeof window !== 'undefined') {
    window.addEventListener('sessionExpired', handleSessionExpired as EventListener);
    return () => window.removeEventListener('sessionExpired', handleSessionExpired as EventListener);
  }
}, []);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–≥–¥–∞ `sessionExpired` —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, UserContext –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

---

### 3. **context/MarketContext.tsx** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ localStorage
```typescript
// –î–û: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∏–∑ MOCK, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å
const [reviews, setReviews] = useState<Review[]>([]);

useEffect(() => {
  const loadData = async () => {
    // ...
    // ‚ùå –î–û: setReviews(MOCK_REVIEWS); <- –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞
    
    // ‚úÖ –ü–û–°–õ–ï: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ localStorage
    const savedReviews = localStorage.getItem('market_reviews');
    if (savedReviews) {
      try {
        setReviews(JSON.parse(savedReviews));
      } catch (e) {
        console.warn('Failed to load saved reviews, using mock:', e);
        setReviews(MOCK_REVIEWS);
      }
    } else {
      setReviews(MOCK_REVIEWS);
    }
  };
  loadData();
}, []);

// ‚úÖ –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ localStorage
useEffect(() => {
  localStorage.setItem('market_reviews', JSON.stringify(reviews));
}, [reviews]);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∏–∑ localStorage
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

### 4. **pages/Login.tsx** - –£–¥–∞–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```typescript
// ‚ùå –î–û:
catch (err) {
  const errorMsg = err instanceof Error ? err.message : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
  setError(errorMsg);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
  if (/Invalid username\/password|invalid/i.test(errorMsg)) {
    await back4app.registerUser(...);
    // ... —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
  }
}

// ‚úÖ –ü–û–°–õ–ï:
catch (err) {
  const errorMsg = err instanceof Error ? err.message : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
  setError(errorMsg); // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è createTestAdmin() –∏ –∫–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å/–≤–æ–π—Ç–∏ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π admin"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–æ–≥–∏–Ω/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã, –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∞–≤—Ç–æ–ø–æ–ø—ã—Ç–æ–∫.

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ + F5
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç ‚Üí sessionToken —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ market_user
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ market_reviews
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç F5 ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
4. App.tsx ‚Üí initializeParse() ‚Üí restoreSession()
5. restoreSession() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç sessionToken —á–µ—Ä–µ–∑ Parse.User.become()
6. –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí ‚úÖ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
7. market_reviews –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ localStorage ‚Üí ‚úÖ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ (403 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
```
1. restoreSession() –ø–æ–ª—É—á–∞–µ—Ç 403 unauthorized
2. localStorage.removeItem('market_user') ‚Üí —É–¥–∞–ª—è–µ–º –º—ë—Ä—Ç–≤—ã–π —Ç–æ–∫–µ–Ω
3. notifySessionExpired() ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
4. UserContext —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ ‚Üí setUser(null)
5. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω"
6. ‚ö†Ô∏è –ù–æ! market_reviews –≤—Å—ë –µ—â—ë –≤ localStorage ‚Üí ‚úÖ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–∏–¥–Ω—ã!
```

---

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ü—Ä–æ–±–ª–µ–º–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|----------|------|-------|
| **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ—Å–ª–µ F5** | ‚ùå –ò—Å—á–µ–∑–∞—é—Ç | ‚úÖ –û—Å—Ç–∞—é—Ç—Å—è (–≤ localStorage) |
| **–°–µ—Å—Å–∏—è –ø–æ—Å–ª–µ F5** | ü§î –ü—É—Ç–∞–Ω–∏—Ü–∞ | ‚úÖ –Ø—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∑–∞–ª–æ–≥–∏–Ω–µ–Ω –∏–ª–∏ 403) |
| **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI** | ‚ùå –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞ | ‚úÖ –°–æ–±—ã—Ç–∏–µ `sessionExpired` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç |
| **–ê–≤—Ç–æ–ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏–Ω–∞** | ‚ùå –°–∫—Ä—ã—Ç—ã–µ, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ | ‚úÖ –Ø–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ |
| **localStorage —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** | ‚ùå –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | ‚úÖ useEffect —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ |

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
```
http://localhost:3000/TEST_AUTO.html
```

### –£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- **–õ–æ–≥–∏–Ω:** `Vladikabh23`
- **–ü–∞—Ä–æ–ª—å:** `111111`

### –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
1. üé¨ –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. üîê –í–æ–π–¥–∏—Ç–µ (Vladikabh23 / 111111)
3. üìù –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
4. üîÑ –ù–∞–∂–º–∏—Ç–µ F5
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Å—Ç–∞–ª—Å—è

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–∏–¥–Ω–∞ –ø–æ—Å–ª–µ F5
‚úÖ localStorage.market_reviews —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–∏–ª–∏ 403 - –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
```

---

## üìö –§–∞–π–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã

```
services/back4app.ts             ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è 403
context/UserContext.tsx          ‚Üê –°–ª—É—à–∞—Ç–µ–ª—å sessionExpired
context/MarketContext.tsx        ‚Üê –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
pages/Login.tsx                  ‚Üê –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–æ–ø—ã—Ç–æ–∫
```

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

‚úÖ **–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**  
‚úÖ **Dev —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://localhost:3000**  
‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Ç–æ–≤**  
‚úÖ **localStorage —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç**  
‚úÖ **sessionExpired —Å–æ–±—ã—Ç–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**  

---

**–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç! üöÄ**
