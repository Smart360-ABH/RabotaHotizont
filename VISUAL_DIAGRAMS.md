# Визуальная диаграмма восстановления сессии

## 🔄 Flow диаграмма: Session Restoration

```
┌─────────────────────────────────────────────────────────────────┐
│                     Пользователь загружает приложение           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │  React App.tsx      │
                    │  useEffect()        │
                    │  (на загрузке)      │
                    └─────────────────────┘
                              │
                ┌─────────────┴──────────────┐
                │                            │
                ▼                            ▼
    ┌────────────────────┐     ┌────────────────────────────┐
    │ initializeParse()  │     │ restoreSession()           │
    │                    │     │                            │
    │ Parse.initialize() │     │ 1. Читает localStorage     │
    │ serverURL设置      │     │ 2. Получает sessionToken  │
    │                    │     │ 3. Parse.User.become()    │
    └────────────────────┘     └────────────────────────────┘
              │                            │
              ▼                            ▼
    ┌────────────────────┐     ┌────────────────────┐
    │ Parse SDK init'd   │     │ Session restored?  │
    │ ✅ Ready          │     │                    │
    └────────────────────┘     └────────────────────┘
              │                    │            │
              │              ✅Yes  │            ❌No
              │                    │            │
              │                    ▼            ▼
              │         ┌──────────────────┐  ┌──────────────┐
              │         │ Parse.User       │  │ Пользователь│
              │         │ .current()       │  │ не залогинен│
              │         │ возвращает       │  └──────────────┘
              │         │ пользователя     │
              │         └──────────────────┘
              │                    │
              └────────────────────┼──────────────────┐
                                   │                  │
                    ┌──────────────┴────────────────┐ │
                    │                               │ │
                    ▼                               ▼ ▼
        ┌───────────────────────────┐      ┌──────────────────┐
        │ Пользователь может:       │      │ App работает      │
        │                           │      │ но пользователь  │
        │ ✅ Просматривать каталог │      │ не авторизован   │
        │ ✅ Добавлять комментарии  │      │                  │
        │ ✅ Загружать файлы        │      │ При попытке      │
        │ ✅ Добавлять в избранное  │      │ действия →       │
        │ ✅ Оформлять заказы       │      │ Редирект на /login
        │ ✅ ВСЕ операции работают  │      │                  │
        │   БЕЗ повторного логина!  │      └──────────────────┘
        └───────────────────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │ Пользователь доволен! 😊  │
        │ Плавный UX без перебоев   │
        └───────────────────────────┘
```

---

## 🔐 Детальный процесс: Parse.User.become()

```
┌─────────────────────────────────────────┐
│ Parse.User.become(sessionToken)         │
│ вызывается в restoreSession()            │
└─────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ Back4App сервер       │
        │ валидирует sessionToken│
        │                       │
        │ SELECT user WHERE     │
        │ sessionToken = '...'  │
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
    ✅Token валиден        ❌Token невалиден
        │                       │
        ▼                       ▼
    ┌─────────────┐         ┌──────────────┐
    │ Вернуть     │         │ Вернуть      │
    │ пользователя│         │ ошибку       │
    │ в браузер   │         │ ParseError   │
    └─────────────┘         └──────────────┘
        │                       │
        ▼                       ▼
    Parse.User.         catch (e) в
    current() = User    restoreSession()
    ✅ Доступен           │
                        localStorage
                        .removeItem()
```

---

## 📊 Timeline: Перезагрузка страницы

```
┌──────────────────────────────────────────────────────────────────┐
│ TIMELINE: Что происходит при F5 на странице приложения          │
└──────────────────────────────────────────────────────────────────┘

0ms        Browser начинает загрузку
           │
           ├─ Скачивает HTML, CSS, JS
           │  └─ Вызывает React
           │
50-100ms   React App.tsx компонент монтируется
           │
           ├─ Вызывается useEffect() hook
           │  │
           │  ├─ initializeParse()
           │  │  ├─ Parse.initialize(APP_ID, JS_KEY)
           │  │  ├─ Parse.serverURL = 'https://...'
           │  │  └─ console.info('Parse инициализирован')
           │  │
           │  ├─ restoreSession()
           │  │  ├─ localStorage.getItem('market_user')
           │  │  ├─ JSON.parse(user)
           │  │  ├─ Parse.User.become(sessionToken)
           │  │  │  ├─ [Сетевой запрос к Back4App]
           │  │  │  └─ Ожидание...
           │  │  │
           │  │  └─ await возвращает результат
           │  │
           │  └─ .then((restored) => { ... })
           │     └─ console.log('✅ User session restored')
           │
           ├─ App полностью загружен ✅
           │
100-200ms  Страница готова к взаимодействию
           │
           ├─ Пользователь может:
           │  ├─ Просматривать контент
           │  ├─ Добавлять комментарии
           │  ├─ Выполнять другие операции
           │  └─ ВСЕ действия требующие auth - работают!
           │
200ms+     Normal operation

```

---

## 🔄 Состояния сессии

```
СОСТОЯНИЕ: Сессия в разных частях приложения

┌─────────────────────────────────────────────────────────────────┐
│ ДО ИСПРАВЛЕНИЯ (❌ Проблемы):                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ React Context:  ✅ Пользователь сохранен                       │
│ localStorage:   ✅ sessionToken в localStorage                 │
│ Parse SDK:      ❌ Parse.User.current() = null                 │
│ Back4App:       ✅ sessionToken валиден на сервере             │
│                                                                 │
│ Результат: Несинхронизированное состояние ❌                   │
│            Операции требующие auth - падают                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ ПОСЛЕ ИСПРАВЛЕНИЯ (✅ Синхронизировано):                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ React Context:  ✅ Пользователь сохранен                       │
│ localStorage:   ✅ sessionToken в localStorage                 │
│ Parse SDK:      ✅ Parse.User.current() = User (восстановлен) │
│ Back4App:       ✅ sessionToken валиден на сервере             │
│                                                                 │
│ Результат: Полная синхронизация ✅                             │
│            Все операции работают без ошибок                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🧪 Тестовые сценарии: Состояния

```
┌──────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 1: Нормальная авторизация и использование              │
├──────────────────────────────────────────────────────────────────┤
│ 1. Пользователь заходит на /login                               │
│ 2. Вводит credentials и нажимает Login                          │
│ 3. Back4App возвращает sessionToken                             │
│ 4. UserContext сохраняет в localStorage                         │
│ 5. ✅ Пользователь может выполнять любые операции              │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 2: Перезагрузка страницы (F5)                          │
├──────────────────────────────────────────────────────────────────┤
│ 1. Пользователь нажимает F5                                      │
│ 2. App.tsx useEffect вызывается                                 │
│ 3. initializeParse() инициализирует Parse SDK                   │
│ 4. restoreSession() восстанавливает из localStorage             │
│ 5. Parse.User.become(sessionToken) валидирует токен            │
│ 6. ✅ Parse.User.current() возвращает пользователя             │
│ 7. ✅ Пользователь остается залогинен                           │
│ 8. ✅ Все операции работают как раньше                         │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 3: Истекший sessionToken                               │
├──────────────────────────────────────────────────────────────────┤
│ 1. SessionToken истекает на Back4App (например, через месяц)    │
│ 2. Пользователь нажимает F5                                      │
│ 3. restoreSession() пытается Parse.User.become()                │
│ 4. Back4App возвращает ошибку: "Invalid session token"          │
│ 5. Catch блок удаляет localStorage.market_user                  │
│ 6. ✅ Пользователь разлогинен                                   │
│ 7. ✅ Редирект на /login (через Router/UserContext)            │
│ 8. ✅ Пользователь может авторизоваться заново                 │
└──────────────────────────────────────────────────────────────────┘
```

---

## 💾 Хранилище данных: Где сохраняется информация

```
┌─────────────────────────────────────────────────────────────────┐
│ localStorage (Browser Storage)                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Ключ: "market_user"                                            │
│                                                                 │
│ Содержимое:                                                    │
│ {                                                              │
│   "objectId": "abc123...",                                     │
│   "username": "john_doe",                                      │
│   "email": "john@example.com",                                 │
│   "sessionToken": "r:xyz789...",  ← КЛЮЧЕВОЙ ЭЛЕМЕНТ!         │
│   ...другие данные пользователя...                            │
│ }                                                              │
│                                                                 │
│ Кто записывает?     UserContext (при login)                   │
│ Кто читает?         restoreSession() (при загрузке)            │
│ Кто удаляет?        restoreSession() (при ошибке/logout)      │
│ Время жизни?        До явного удаления или истечения токена   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Parse SDK (In-Memory State)                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Parse.User.current() - текущий авторизованный пользователь     │
│                                                                 │
│ Кто устанавливает? Parse.User.become(sessionToken)            │
│ Кто читает?        uploadFile(), другие функции требующие auth │
│ Время жизни?       До перезагрузки страницы (SPA context)     │
│ Проблема?         Теряется при перезагрузке без восстановления│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Back4App Server (Remote)                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Sessions Database: sessionToken -> User mapping                │
│                                                                 │
│ Кто проверяет?      Back4App при каждом запросе с токеном     │
│ Время жизни?        Настраивается в Back4App (обычно 30 дней) │
│ Валидация?          Встроенная валидация на сервере            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

СИНХРОНИЗАЦИЯ:
─────────────
                    ┌─ localStorage
                    │
         Parse SDK ─┤─ Back4App  (через sessionToken)
                    │
                    └─ React Context

После восстановления все три синхронизированы ✅
```

---

## 📱 Flow на мобильном устройстве

```
МОБИЛЬНОЕ ПРИЛОЖЕНИЕ (браузер):
──────────────────────────────

┌─────────────────────────────────┐
│ Пользователь открывает app      │
│ на браузере мобильного телефона │
└─────────────────────────────────┘
           │
           ▼
    ┌─────────────────┐
    │ App загружается │
    │ initializeParse │
    │ restoreSession  │
    └─────────────────┘
           │
           ▼
    ┌─────────────────────────────────┐
    │ Пользователь использует app:    │
    │ ✅ Добавляет комментарии         │
    │ ✅ Загружает фото                │
    │ ✅ Добавляет в избранное         │
    │ ✅ Оформляет заказы             │
    └─────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────┐
    │ Пользователь минимизирует браузер│
    │ (закрывает tab, но не приложение)│
    └──────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────┐
    │ Позже: Открывает браузер заново  │
    │ (вернулся на нашу страницу)      │
    └──────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────┐
    │ ✅ localStorage СОДЕРЖИТ         │
    │    market_user с sessionToken     │
    │                                  │
    │ App.tsx useEffect:               │
    │ initializeParse() ✅             │
    │ restoreSession() ✅              │
    │                                  │
    │ ✅ Parse.User.current() заполнен │
    │ ✅ Пользователь не разлогинен    │
    │ ✅ Может продолжить работу       │
    └──────────────────────────────────┘

БЕЗ ЭТОГО ИСПРАВЛЕНИЯ:
Пользователь был бы разлогинен и потерял бы сессию ❌

С ИСПРАВЛЕНИЕМ:
Seamless experience - продолжает работу как будто не закрывал браузер ✅
```

---

## 🎯 Ключевые моменты исправления

```
1️⃣ ИНИЦИАЛИЗАЦИЯ Parse SDK
   └─ initializeParse() при загрузке App
   └─ Без этого Parse.User.current() всегда = null

2️⃣ ВОССТАНОВЛЕНИЕ sessionToken
   └─ restoreSession() вызывает Parse.User.become()
   └─ Валидирует token с Back4App
   └─ Синхронизирует localStorage с Parse SDK

3️⃣ ОБРАБОТКА ОШИБОК
   └─ Если token невалиден → удалить из localStorage
   └─ Пользователь разлогинен → редирект на /login

4️⃣ АВТОМАТИЧЕСКИЙ sessionToken
   └─ uploadFile() и другие функции автоматически получают
   └─ sessionToken из Parse.User.current()
   └─ Не требуется передавать вручную

РЕЗУЛЬТАТ:
──────────
Seamless session persistence across page reloads ✅
Улучшенный UX без потери данных и контекста ✅
```

---

Эти диаграммы помогут визуально понять как работает восстановление сессии!
